<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>
        <LINK rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
              crossorigin="anonymous"/>

        <LINK href="/styles/grid.css"
              rel="stylesheet"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>

        <SCRIPT type="text/javascript">
            window.onload = function() {
                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                var currentPage = (params.page == null ? 1 : params.page);

                const api = new BookingAPI();
                api.listBookings(currentPage, function (json) {
                    var table = document.getElementById("bookingsTable");
                    var oldTbody = table.tBodies[0];
                    var newTbody = document.createElement("tbody");

                    json.results.forEach(x => {
                        var newRow = newTbody.insertRow(-1);

                        var link = document.createElement('a');
                        link.setAttribute('href', "/booking/viewBooking.html?id=" + x.id);
                        link.innerText = x.number;
                        var newCell = newRow.insertCell(0);
                        newCell.appendChild(link);

                        newCell = newRow.insertCell(1);
                        newCell.appendChild(document.createTextNode(x.created_by.username));

                        newCell = newRow.insertCell(2);
                        newCell.appendChild(document.createTextNode(x.flightLegs.length + " flight legs"));

                        newCell = newRow.insertCell(3);
                        newCell.appendChild(document.createTextNode(x.passengers.length + " passengers"));

                        newCell = newRow.insertCell(4);
                        if (x.travelInsurance == null) {
                            newCell.appendChild(document.createTextNode("-"));
                        }
                        else {
                            newCell.appendChild(document.createTextNode(x.travelInsurance.title));
                        }

                        newCell = newRow.insertCell(5);
                        if (x.rentalCar == null) {
                            newCell.appendChild(document.createTextNode("-"));
                        }
                        else {
                            newCell.appendChild(document.createTextNode(x.rentalCar.make + " " + x.rentalCar.model));
                        }
                    });

                    oldTbody.parentNode.replaceChild(newTbody, oldTbody);

                    if (json.count < 10) {
                        document.getElementById("paginationNav").style.display = "none";
                    }
                    else {
                        var ul = document.getElementById("paginationList");
                        while (ul.hasChildNodes()) {
                            ul.removeChild(ul.firstChild);
                        }

                        var totalPages = Math.floor(json.count / 10);
                        if (json.count % 10 != 0) {
                            ++totalPages;
                        }

                        const maxVisiblePages = 3;
                        var firstPage = currentPage - 1;
                        if (firstPage < 1) {
                            firstPage = 1;
                        }

                        // insert a left chevron icon if required
                        if (totalPages > maxVisiblePages && (currentPage - 2) > 0) {
                            createAndAppendItem(ul, currentPage - 2, "&laquo;", false);
                        }

                        for (var i = 0; i < maxVisiblePages && (firstPage + i) <= totalPages; ++i) {
                            createAndAppendItem(ul, firstPage + i, firstPage + i, firstPage + i == currentPage);
                        }

                        // insert a right chevron icon if required
                        if (totalPages > maxVisiblePages && (currentPage + 2) < totalPages) {
                            createAndAppendItem(ul, currentPage + 2, "&raquo;", false);
                        }

                        document.getElementById("paginationNav").style.display = "";
                    }
                },
                function(code, json) {
                    var table = document.getElementById("bookingsTable");
                    var oldTbody = table.tBodies[0];
                    var newTbody = document.createElement("tbody");

                    var newRow = newTbody.insertRow(-1);
                    var newCell = newRow.insertCell(0);
                    newCell.appendChild(document.createTextNode("code: " + code + ", message: " + json.detail));

                    oldTbody.parentNode.replaceChild(newTbody, oldTbody);
                });
            }

            function createAndAppendItem(list, pageIndex, text, active) {
                var li = document.createElement("li");
                li.setAttribute("class", active ? "page-item active" : "page-item");

                var e;
                if (active) {
                    e = document.createElement("span");
                }
                else {
                    e = document.createElement("a");
                    e.setAttribute("href", "/info/listBookings.html?page=" + pageIndex);
                }

                e.setAttribute("class", "page-link");
                e.innerHTML = text;
                li.appendChild(e);

                list.appendChild(li);
            }
        </SCRIPT>

    </HEAD>
    <BODY>
        <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <DIV class="container-fluid">
                <A class="navbar-brand"
                    href="/">Home</A>
                <BUTTON class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarCollapse"
                        aria-controls="navbarCollapse"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <SPAN class="navbar-toggler-icon"/>
                </BUTTON>
                <DIV class="collapse navbar-collapse"
                        id="navbarCollapse">
                    <UL class="navbar-nav me-auto mb-2 mb-md-0">
                        <LI class="nav-item">
                            <A class="nav-link"
                                href="/info/listFlights.html">Flights</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link"
                                href="/info/listAeroplanes.html">Aeroplanes</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link"
                                href="/user/editUser.html">User</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link active"
                                href="/booking/listBookings.html">Bookings</A>
                        </LI>
                        <LI class="nav-item">
                            <BUTTON class="btn btn-primary"
                                    type="button"
                                    onclick="window.location.href = '/booking/bookAFlight.html'">Book a Flight</BUTTON>
                        </LI>
                    </UL>
                    <FORM class="d-flex">
                        <INPUT class="form-control me-2"
                                type="search"
                                placeholder="Search"
                                aria-label="Search"/>
                        <BUTTON class="btn btn-success"
                                type="submit"
                                onclick="alert('TODO');">Search</BUTTON>
                    </FORM>
                </DIV>
            </DIV>
        </NAV>
        <MAIN class="container">
            <header class="pb-3 mb-5 border-bottom">
                <h1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <svg class="bi" width="32" height="32" fill="currentColor">
                        <use xlink:href="/images/bootstrap-icons.svg#calendar3"/>
                    </svg>
                    <span>&nbsp;Bookings</span>
                </h1>
            </header>

            <table id="bookingsTable" class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">Number</th>
                    <th scope="col">Created By</th>
                    <th scope="col">Flight Legs</th>
                    <th scope="col">Passengers</th>
                    <th scope="col">Travel Insurance</th>
                    <th scope="col">Rental Car</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <NAV id="paginationNav" aria-label="Bookings Pagination" style="display: none;">
                <UL id="paginationList" class="pagination justify-content-end"></UL>
            </NAV>
            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
                </P>
                <P>Booking icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>
        </MAIN>
        <SCRIPT src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous">
        </SCRIPT>
    </BODY>
</HTML>
