<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>
        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous"/>
        <LINK rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
        <LINK href="/styles/grid.css" rel="stylesheet"/>
        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>
        <SCRIPT type="text/javascript">
            window.onload = function() {
                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                var link = document.getElementById("cancel");
                link.setAttribute('href', "/booking/viewBooking.html?id=" + params.bookingId);
                
                var span = document.getElementById("pageHeading");
                var div = document.getElementById("deleteButtonDiv");
                var button = document.getElementById("saveButton");

                if (params.mode != null && params.mode === "add") {
                    span.innerHTML = "&nbsp;Add Passenger";
                    div.style.display = "none";
                    button.innerHTML = "<i class='fa-solid fa-add'></i>&nbsp;Add";
                }
                else if (params.id != null) {
                    span.innerHTML = "&nbsp;Passenger Details";
                    div.style.display = "";
                    button.innerHTML = "<i class='fa-solid fa-floppy-disk'></i>&nbsp;Save";

                    const api = new BookingAPI();
                    api.getPassenger(params.id,
                        function (json) {
                            document.getElementById("title").value = json.title;
                            document.getElementById("firstName").value = json.first_name;
                            document.getElementById("lastName").value = json.second_name;
                            document.getElementById("emailAddress").value = json.email_address;
                            document.getElementById("phoneNumber").value = json.phone_number;
                            document.getElementById("specialAssistance").value = json.special_assistance;
                        },
                        function(code, json) {
                            document.getElementById("title").value = "code: " + code + ", message: " + json.detail;
                        });
                }
            }

            function deletePassenger() {
                document.getElementById("deleteConfirmationTitle").innerText = "Deleting...";
                document.getElementById("deleteText").style.display = "none";
                document.getElementById("cancelButton").disabled = true;
                document.getElementById("deleteButton").disabled = true;
                document.getElementById("deleteSpinner").style.display = "";

                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                const api = new BookingAPI();
                api.deletePassenger(params.id,
                    function(json) {
                        setTimeout(function() {
                            document.location.href = "/booking/viewBooking.html?id=" + params.bookingId;
                        }, 500);
                    },
                    function(code, json) {
                        document.getElementById("deleteConfirmationTitle").innerText = "Error";
                        document.getElementById("deleteText").innerHTML =
                            "Unable to delete the passenger.<br/><br/>ERROR: " + code + ", Message: " + json.detail;
                        document.getElementById("deleteText").style.display = "";
                        document.getElementById("cancelButton").disabled = false;
                        document.getElementById("deleteButton").disabled = false;
                        document.getElementById("deleteSpinner").style.display = "none";
                    });
            }

            function savePassenger() {
                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                const api = new BookingAPI();
                if (params.mode != null && params.mode === "add") {
                    api.addPassenger(
                        document.getElementById("title").value,
                        document.getElementById("firstName").value,
                        document.getElementById("lastName").value,
                        document.getElementById("emailAddress").value,
                        document.getElementById("phoneNumber").value,
                        document.getElementById("specialAssistance").value,
                        function(json) {
                            addPassengerToBooking(api, params.bookingId, json.id);
                        },
                        function(code, json) {
                            document.getElementById("title").value = "code: " + code + ", message: " + json.detail;
                        });
                }
                else {
                    api.modifyPassenger(params.id,
                        document.getElementById("title").value,
                        document.getElementById("firstName").value,
                        document.getElementById("lastName").value,
                        document.getElementById("emailAddress").value,
                        document.getElementById("phoneNumber").value,
                        document.getElementById("specialAssistance").value,
                        function(json) {
                            document.location.href = "/booking/viewBooking.html?id=" + params.bookingId;
                        },
                        function(code, json) {
                            document.getElementById("title").value = "code: " + code + ", message: " + json.detail;
                        });
                }
            }

            function addPassengerToBooking(api, bookingId, newPassengerId) {
                api.getCompactBooking(bookingId,
                    function(json) {
                        api.modifyBooking(bookingId,
                            json.number,
                            json.travelInsurance,
                            json.rentalCar,
                            json.flightLegs,
                            json.passengers.concat(newPassengerId),
                            function(json) {
                                setTimeout(function() {
                                    document.location.href = "/booking/viewBooking.html?id=" + bookingId;
                                }, 500);
                            },
                            function(code, json) {
                                document.getElementById("title").value = "code: " + code + ", message: " + json.detail;
                            });
                    },
                    function(code, json) {
                        document.getElementById("title").value = "code: " + code + ", message: " + json.detail;
                    });
            }

            function saveButtonclicked() {
                const forms = document.querySelectorAll('.needs-validation');
                Array.from(forms).forEach(form => {
                    if (form.checkValidity()) {
                        formFieldset.disabled = true;
                        saveSpinner.style.display = "";
                        savePassenger();
                    }
                    else {
                        event.preventDefault();
                        event.stopPropagation();
                        form.classList.add('was-validated');
                    }
                }, false);
            }
        </SCRIPT>
    </HEAD>
    <BODY>
        <HEADER>
            <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
                <DIV class="container-fluid">
                    <A class="navbar-brand" href="/">Home</A>
                    <BUTTON class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <SPAN class="navbar-toggler-icon"/>
                    </BUTTON>
                    <DIV class="collapse navbar-collapse" id="navbarCollapse">
                        <UL class="navbar-nav me-auto mb-2 mb-md-0">
                            <LI class="nav-item">
                                <A class="nav-link active" href="/info/listFlights.html">Flights</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link" href="/info/listAeroplanes.html">Aeroplanes</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link" href="/user/editUser.html">User</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link" href="/booking/listBookings.html">Bookings</A>
                            </LI>
                            <LI class="nav-item">
                                <BUTTON class="btn btn-primary" type="button" onclick="window.location.href = '/booking/bookAFlight.html'">Book a flight</BUTTON>
                            </LI>
                        </UL>
                        <FORM class="d-flex">
                            <INPUT class="form-control me-2" type="search" placeholder="Search" aria-label="Search"/>
                            <BUTTON class="btn btn-success" type="submit" onclick="alert('TODO');">Search</BUTTON>
                        </FORM>
                    </DIV>
                </DIV>
            </NAV>
        </HEADER>
        <MAIN class="container">
            <HEADER class="pb-3 mb-5 border-bottom">
                <H1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <i class="fa-solid fa-person"></i>
                    <SPAN id="pageHeading"></SPAN>
                </H1>
            </HEADER>

            <FORM class="mb-4 needs-validation" novalidate>
                <fieldset id="formFieldset">
                    <DIV class="row justify-content-end" id="deleteButtonDiv" style="display: none;">
                        <DIV class="col-2 text-end">
                            <button type="button" class="btn btn-danger mt-5" data-bs-toggle="modal" data-bs-target="#deleteConfirmation">
                                <i class="fa-solid fa-trash"></i>&nbsp;Delete
                            </button>
                        </DIV>
                    </DIV>

                    <DIV class="row">
                        <DIV class="col">
                            <LABEL for="title">Title</LABEL>
                            <INPUT type="text" class="form-control" id="title" placeholder="Title"/>
                        </DIV>
                        <DIV class="col">
                            <LABEL for="firstName">First Name</LABEL>
                            <INPUT type="text" class="form-control" id="firstName" placeholder="First Name" required/>
                            <div class="valid-feedback">Looks good!</div>
                            <div class="invalid-feedback">Please enter a first name</div>
                        </DIV>
                        <DIV class="col">
                            <LABEL for="lastName">Last Name</LABEL>
                            <INPUT type="text" class="form-control" id="lastName" placeholder="Last Name" required/>
                            <div class="valid-feedback">Looks good!</div>
                            <div class="invalid-feedback">Please enter a last name</div>
                        </DIV>
                    </DIV>

                    <DIV class="row">
                        <DIV class="col">
                            <LABEL for="emailAddress">Email Address</LABEL>
                            <INPUT type="text" class="form-control" id="emailAddress" placeholder="Email Address"/>
                        </DIV>
                        <DIV class="col">
                            <LABEL for="phoneNumber">Phone Number</LABEL>
                            <INPUT type="text" class="form-control" id="phoneNumber" placeholder="Phone Number" required/>
                            <div class="valid-feedback">Looks good!</div>
                            <div class="invalid-feedback">Please enter a phone number</div>
                        </DIV>
                    </DIV>

                    <DIV class="row mb-4">
                        <DIV class="col">
                            <LABEL for="specialAssistance">Special Assistance</LABEL>
                            <INPUT type="text" class="form-control" id="specialAssistance" placeholder="Special Assistance"/>
                        </DIV>
                    </DIV>
                </fieldset>

                <DIV class="row justify-content-end">
                    <DIV class="col" id="saveSpinner" style="display: none;">
                        <span class="d-flex align-items-center justify-content-end">
                            <SPAN class="spinner-border text-end text-success" role="status"></SPAN>
                            <SPAN class="text-success fw-bold">&nbsp;Saving...</SPAN>
                        </span>
                    </DIV>
                    <DIV class="col-md-auto text-end">
                        <button type="button" id="saveButton" class="btn btn-primary" onclick="saveButtonclicked();"><i class="fa-solid fa-floppy-disk"></i>&nbsp;Save</button>
                        <A class="btn btn-secondary" id="cancel" href="/booking/viewBooking.html">Cancel</A>
                    </DIV>
                </DIV>
            </FORM>

            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
                </P>
                <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>

            <div class="modal fade" id="deleteConfirmation" tabindex="-1" aria-labelledby="deleteConfirmationTitle" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteConfirmationTitle">Are you sure?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                        </div>
                        <div class="modal-body">
                            <p id="deleteText">This action cannot be undone. The passenger will be <b>permanently</b> deleted.</p>
                            <div class="text-center" id="deleteSpinner" style="display: none;">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Deleting...</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="deleteButton" onclick="deletePassenger()"><i class="fa-solid fa-trash"></i>&nbsp;Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
        </MAIN>
    </BODY>
</HTML>
