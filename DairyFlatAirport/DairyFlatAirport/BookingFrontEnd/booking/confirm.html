<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>

        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"/>
        <LINK rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <LINK href="/styles/grid.css" rel="stylesheet"/>
        <LINK href="/styles/wizard.css" rel="stylesheet"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>
        <SCRIPT type="text/javascript" src="/javascript/booking.js"></SCRIPT>
        
        <SCRIPT type="text/javascript">
            window.onload = function() {
                const booking = new Booking();
                insertFlights(booking);
                insertPassengers(booking);
                insertExtas(booking);
                insertSeats(booking);
                totalCost.innerText = booking.getTotalCost();
            }

            function insertFlights(booking) {
                fromCityName1.innerText = booking.getFromCityName();
                fromCityName2.innerText = booking.getFromCityName();
                fromCityDate.innerText = toLocaleDate(new Date(booking.getLeaveDate()), booking.getTimezone());
                fromCityTime.innerHTML = buildTimeHtml(booking.getLeaveTime());

                toCityName1.innerText = booking.getToCityName();
                toCityName2.innerText = booking.getToCityName();
                toCityDate.innerText = toLocaleDate(new Date(booking.getReturnDate()), booking.getTimezone());
                toCityTime.innerHTML = buildTimeHtml(booking.getReturnTime());

                outboundTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getOutboundFlightCost();
                returnTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getInboundFlightCost();

                if (!booking.isReturnTrip()) {
                    returnFlightGUI.style.display = 'none';
                    returnFlightSeatsGUI.style.display = 'none';
                }
            }

            function calcNumDays(booking) {
                const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
                const firstDate = new Date(booking.getLeaveDate());
                const secondDate = new Date(booking.getReturnDate());
                return Math.round(Math.abs((firstDate - secondDate) / oneDay));
            }

            function insertPassengers(booking) {
                passengers.appendChild(makePassengerDiv(booking.getDisplayName1()));
                if (booking.getNumPassengers() > 1) passengers.appendChild(makePassengerDiv(booking.getDisplayName2()));
                if (booking.getNumPassengers() > 2) passengers.appendChild(makePassengerDiv(booking.getDisplayName3()));
                if (booking.getNumPassengers() > 3) passengers.appendChild(makePassengerDiv(booking.getDisplayName4()));
                if (booking.getNumPassengers() > 4) passengers.appendChild(makePassengerDiv(booking.getDisplayName5()));
                if (booking.getNumPassengers() > 5) passengers.appendChild(makePassengerDiv(booking.getDisplayName6()));
            }

            function makePassengerDiv(name) {
                var div = document.createElement('div');
                div.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + name;
                return div;
            }

            function insertExtas(booking) {
                if (booking.hasTravelInsuranceName()) {
                    let value1 = '$' + booking.getTravelInsuranceCost() + ' per person';
                    let value2 = booking.getNumPassengers() + ' \u00D7 $' + booking.getTravelInsuranceCost();
                    extras.appendChild(makeExtrasDiv(booking, booking.getTravelInsuranceName(), value1, value2, false));
                }
                else {
                    extras.appendChild(makeExtrasDiv(booking, "No travel insurance", null, null, true));
                }

                if (booking.hasRentalCarName()) {
                    let value1 = '$' + booking.getRentalCarCost() + ' per day';
                    let value2 = calcNumDays(booking) + ' \u00D7 $' + booking.getRentalCarCost();
                    extras.appendChild(makeExtrasDiv(booking, booking.getRentalCarName(), value1, value2, false));
                }
                else {
                    extras.appendChild(makeExtrasDiv(booking, "No rental car", null, null, true));
                }
            }

            function makeExtrasDiv(booking, name, value1, value2, mutedItalic) {
                var div = document.createElement('div');
                if (mutedItalic) {
                    div.setAttribute('class', 'text-muted fst-italic');
                    div.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + name;
                }
                else {
                    var row = document.createElement('div');
                    row.setAttribute('class', 'row');
                    var col = document.createElement('div');
                    col.setAttribute('class', 'col');
                    col.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + name;
                    row.appendChild(col);
                    div.appendChild(row);

                    var row = document.createElement('div');
                    row.setAttribute('class', 'row');
                    var col = document.createElement('div');
                    col.setAttribute('class', 'col');
                    col.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + value1;
                    row.appendChild(col);
                    col = document.createElement('div');
                    col.setAttribute('class', 'col-md-auto');
                    col.innerText = value2;
                    row.appendChild(col);
                    div.appendChild(row);
                }
                return div;
            }

            function insertSeats(booking) {
                insertOutboundSeats(booking);
                insertInboundSeats(booking);
            }

            function insertOutboundSeats(booking) {
                var div = document.createElement('div');
                div.setAttribute('class', 'row my-1');
                var a = makeSeatsColumns(booking.getDisplayName1(), booking.getOutboundSeatName1());
                div.appendChild(a[0]);
                div.appendChild(a[1]);
                outboundSeats.appendChild(div);

                if (booking.getNumPassengers() > 1) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName2(), booking.getOutboundSeatName2());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    outboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 2) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName3(), booking.getOutboundSeatName3());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    outboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 3) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName4(), booking.getOutboundSeatName4());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    outboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 4) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName5(), booking.getOutboundSeatName5());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    outboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 5) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName6(), booking.getOutboundSeatName6());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    outboundSeats.appendChild(div);
                }
            }

            function insertInboundSeats(booking) {
                var div = document.createElement('div');
                div.setAttribute('class', 'row my-1');
                var a = makeSeatsColumns(booking.getDisplayName1(), booking.getInboundSeatName1());
                div.appendChild(a[0]);
                div.appendChild(a[1]);
                inboundSeats.appendChild(div);

                if (booking.getNumPassengers() > 1) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName2(), booking.getInboundSeatName2());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    inboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 2) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName3(), booking.getInboundSeatName3());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    inboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 3) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName4(), booking.getInboundSeatName4());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    inboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 4) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName5(), booking.getInboundSeatName5());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    inboundSeats.appendChild(div);
                }

                if (booking.getNumPassengers() > 5) {
                    var div = document.createElement('div');
                    div.setAttribute('class', 'row my-1');
                    var a = makeSeatsColumns(booking.getDisplayName6(), booking.getInboundSeatName6());
                    div.appendChild(a[0]);
                    div.appendChild(a[1]);
                    inboundSeats.appendChild(div);
                }
            }

            function makeSeatsColumns(columnA, columnB) {
                var divA = document.createElement('div');
                divA.setAttribute('class', 'col');
                divA.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + columnA;

                var divB = document.createElement('div');
                divB.setAttribute('class', 'col');
                divB.innerText = columnB;
                return [divA, divB];
            }

            function toLocaleDate(dateTime, timezone) {
                return new Date(dateTime).toLocaleDateString([],
                                {
                                    timeZone: timezone,
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short'
                                });
            }

            function buildTimeHtml(timeString) {
                const re = /(\d+:\d\d\s(AM|PM))\s(.+)/;
                const results = re.exec(timeString);
                if (results != null && results.length > 3) {
                    return '<span>' + results[1] + '</span> ' +
                           '<small class="text-muted fst-italic" style="font-size: x-small">' + results[3] + '</small>';
                }
                return '';
            }

            function enableConfirmGui(enable) {
                confirmingSpinner.style.display = enable ? 'none' : '';
                confirmingIcon.style.display = enable ? '' : 'none';
                confirmingText.innerText = enable ? 'Confirm' : 'Booking...';
                confirmButton.disabled = !enable;
                if (enable) {
                    previousButton.setAttribute('class', 'btn btn-secondary mb-4');
                }
                else {
                    previousButton.setAttribute('class', 'btn btn-secondary mb-4 disabled');
                }
            }

            function confirmBooking() {
                enableConfirmGui(false);

                const booking = new Booking();

                let number = ''; // TODO: invent the booking number

                let flightLegIdsArray = [];
                if (booking.hasOutboundFlightId()) {
                    flightLegIdsArray.push(booking.getOutboundFlightId());
                }
                if (booking.hasInboundFlightId()) {
                    flightLegIdsArray.push(booking.getInboundFlightId());
                }

                let passengerIdsArray = []; // TODO: create the passengers, save their IDs here

                const api = new BookingAPI();
                setTimeout(function() {
                    api.addBooking(
                        number,
                        booking.hasTravelInsuranceId() ? booking.getTravelInsuranceId() : null,
                        booking.hasRentalCarId() ? booking.getRentalCarId() : null,
                        flightLegIdsArray,
                        passengerIdsArray,
                        function (json) {
                            // TODO: save the booking number?
                            window.location.href = '/booking/invoice.html';
                        },
                        function (code, json) {
                            showHttpError(code, json);
                            enableConfirmGui(true);
                        });
                    }, 1000);
            }

            function showHttpError(code, json) {
                errorMessageTitle.innerText = 'Error Received';
                errorMessageBody.innerHTML = 'The server returned HTTP code ' + code + '.<BR><BR>' + javascriptObjectToDivs(json);
                showError();
            }

            function javascriptObjectToDivs(object) {
                let html = '';
                for (var key of Object.keys(object)) {
                    html = '<div class="row"><div class="col">' + key + ': ' + object[key] + '</div></div>\r\n';
                }
                return html;
            }

            function showError() {
                const toastLiveExample = document.getElementById('responseCodePopup');
                const toast = new bootstrap.Toast(toastLiveExample);
                toast.show();
            }
        </SCRIPT>
    </HEAD>
    <BODY>
        <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <DIV class="container-fluid">
                <A class="navbar-brand" href="/">Home</A>
                <BUTTON class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <SPAN class="navbar-toggler-icon"/>
                </BUTTON>
                <DIV class="collapse navbar-collapse" id="navbarCollapse">
                    <UL class="navbar-nav me-auto mb-2 mb-md-0">
                        <LI class="nav-item">
                            <A class="nav-link active" href="/info/listFlights.html">Flights</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/info/listAeroplanes.html">Aeroplanes</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/user/editUser.html">User</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/booking/listBookings.html">Bookings</A>
                        </LI>
                        <LI class="nav-item">
                            <BUTTON class="btn btn-success" type="button" onclick="window.location.href = '/booking/bookAFlight.html'">
                                <i class="fa-solid fa-plane"></i>&nbsp;Book a Flight</BUTTON>
                        </LI>
                    </UL>
                </DIV>
            </DIV>
        </NAV>
        <MAIN class="container">
            <HEADER class="pb-3 mt-3 mb-5 border-bottom">
                <h1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <i class="fa-solid fa-calendar-check"></i>
                    <span>&nbsp;Book a Flight</span>
                </h1>
            </header>

            <DIV class="row mb-5">
                <ul class="wizard-progress">
                    <li class="wizard-step completed" id="searchStep" onclick="window.location.href='/booking/bookAFlight.html?source=session';">Search</li>
                    <li class="wizard-step completed" id="searchFlights" onclick="window.location.href='/booking/selectFlights.html';">Flights</li>
                    <li class="wizard-step completed" id="searchPassengers" onclick="window.location.href='/booking/passengerDetails.html';">Passengers</li>
                    <li class="wizard-step completed" id="searchExtras" onclick="window.location.href='/booking/extras.html';">Extras</li>
                    <li class="wizard-step completed" id="searchSeats" onclick="window.location.href='/booking/selectSeats.html';">Seats</li>
                    <li class="wizard-step active" id="searchConfirm">Confirm</li>
                    <li class="wizard-step" id="searchInvoice">Invoice</li>
                </ul>
            </DIV>

            <div class="row mb-4 justify-content-center">
                <div class="col-md-6">
                    <h4 class="mb-3 text-primary">Confirmation</h4>

                    <div class="row card mb-4">
                        <div class="card-header">
                            <h5 class="text-primary">Your Booking</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <h5 class="card-title">Flights</h5>
                                <div class="row">
                                    <div class="col"><h6 class="card-title">Outbound trip</h6></div>
                                    <div class="col-md-auto"><span id="outboundTripCost"></span></div>
                                </div>
                                <p class="card-text my-0">
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-success fw-bold" id="fromCityName1"></span> to <span class="text-success fw-bold" id="toCityName1"></span>
                                </p>
                                <p class="card-text">
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span id="fromCityDate"></span>&nbsp;<span id="fromCityTime"></span>
                                </p>
                                <span id="returnFlightGUI">
                                    <div class="row">
                                        <div class="col"><h6 class="card-title">Return trip</h6></div>
                                        <div class="col-md-auto"><span id="returnTripCost"></span></div>
                                    </div>
                                    <p class="card-text my-0">
                                        &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-success fw-bold" id="toCityName2"></span> to <span class="text-success fw-bold" id="fromCityName2"></span>
                                    </p>
                                    <p class="card-text">
                                        &nbsp;&nbsp;&nbsp;&nbsp;<span id="toCityDate"></span>&nbsp;<span id="toCityTime"></span>
                                    </p>
                                </span>
                            </p>
                            <HR />
                            <p class="card-text">
                                <h5 class="card-title">Passengers</h5>
                                <p class="card-text my-0" id="passengers"></p>
                            </p>
                            <HR />
                            <p class="card-text">
                                <h5 class="card-title">Extras</h5>
                                <p class="card-text my-0" id="extras"></p>
                            </p>
                            <HR />
                            <p class="card-text">
                                <h5 class="card-title">Seats</h5>
                                <h6 class="card-title">Outbound seats</h6>
                                <span id="outboundSeats"></span>
                                <span id="returnFlightSeatsGUI">
                                    <h6 class="card-title mt-3">Return seats</h6>
                                    <span id="inboundSeats"></span>
                                </span>
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <span class="col">Total (NZD)</span>
                                <strong class="col text-end">$<span id="totalCost">0</span></strong>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-between">
                        <div class="col col-md-auto">
                            <a class="btn btn-secondary mb-4" href="/booking/selectSeats.html" id="previousButton">
                                <i class="fa-solid fa-circle-arrow-left"></i>&nbsp;Previous
                            </a>
                        </div>
                        <div class="col col-md-auto">
                            <button type="button" class="btn btn-success mb-4" id="confirmButton" onclick="confirmBooking();">
                                <div class="spinner-border spinner-border-sm" id="confirmingSpinner" role="status" style="display: none;">
                                    <span class="visually-hidden">Deleting...</span>
                                </div>
                                <i class="fa-solid fa-circle-check" id="confirmingIcon"></i>&nbsp;<span id="confirmingText">Confirm</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
                </P>
                <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>
        </MAIN>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="responseCodePopup" class="toast fade" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger">
                    <strong class="me-auto text-white" id="errorMessageTitle"></strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorMessageBody"></div>
            </div>
        </div>

        <SCRIPT src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
        </SCRIPT>
    </BODY>
</HTML>
