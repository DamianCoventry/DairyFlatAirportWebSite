<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>

        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
                integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"/>
        <LINK href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"
                integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
                crossorigin="anonymous" referrerpolicy="no-referrer" />

        <LINK href="/styles/grid.css" rel="stylesheet"/>
        <LINK href="/styles/wizard.css" rel="stylesheet"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>
        <SCRIPT type="text/javascript" src="/javascript/booking.js"></SCRIPT>

        <SCRIPT type="text/javascript">
            var outboundFlightCounts = [];
            var inboundFlightCounts = [];

            window.onload = function() {
                const booking = new Booking();

                fromCityName1.innerText = booking.getFromCityName();
                fromCityName2.innerText = booking.getFromCityName();
                fromCityName3.innerText = booking.getFromCityName();

                toCityName1.innerText = booking.getToCityName();
                toCityName2.innerText = booking.getToCityName();
                toCityName3.innerText = booking.getToCityName();
                numPassengers.innerText = booking.getNumPassengers();

                fromCityDate.innerText = toLocaleDate(new Date(booking.getLeaveDate()), booking.getTimezone());
                toCityDate.innerText = toLocaleDate(new Date(booking.getReturnDate()), booking.getTimezone());

                leaveDate.value = booking.getLeaveDate();
                returnDate.value = booking.getReturnDate();

                updateBookingTripCosts(booking);

                if (booking.hasRentalCarName()) {
                    rentalCarBookingGUI.innerHTML = booking.getRentalCarName() + ' <small class="text-muted fst-italic">($' + booking.getRentalCarCost() + ' per day)</small>';
                    rentalCarCostBookingGUI.innerText = calcNumDays(booking) + ' \u00D7 $' + booking.getRentalCarCost();
                }
                else {
                    rentalCarBookingGUI.innerHTML = '<span class="text-muted fst-italic">No rental car</span>'
                }

                if (booking.hasTravelInsuranceName()) {
                    travelInsuranceBookingGUI.innerHTML = booking.getTravelInsuranceName() + ' <small class="text-muted fst-italic">($' + booking.getTravelInsuranceCost() + ' per person)</small>';
                    travelInsuranceCostBookingGUI.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getTravelInsuranceCost();
                }
                else {
                    travelInsuranceBookingGUI.innerHTML = '<span class="text-muted fst-italic">No travel insurance</span>'
                }
                
                // TODO: change calendar to a spinner?

                fetchFlightCountsOnThisDate(booking, booking.getLeaveDate(), booking.getTimezone(), true);
                searchFlights(
                    1, "departsFlightTable",
                    booking.getFromCityId(), booking.getToCityId(),
                    booking.getLeaveDate(), booking.getTimezone(),
                    true);

                if (booking.isReturnTrip()) {
                    fetchFlightCountsOnThisDate(booking, booking.getReturnDate(), booking.getTimezone(), false);
                    searchFlights(
                        1, "arrivesFlightTable",
                        booking.getFromCityId(), booking.getToCityId(),
                        booking.getReturnDate(), booking.getTimezone(),
                        false);
                }
                else {
                    returnFlightGUI.style.display = 'none';
                    returnFlightBookingGUI.style.display = 'none';
                }
            }

            function fetchFlightCountsOnThisDate(booking, flightDate, timezone, outbound) {
                if (outbound) {
                    outboundFlightCounts = [];
                }
                else {
                    inboundFlightCounts = [];
                }

                const firstDate = calculateFirstDate(flightDate);
                const lastDate = calculateLastDate(flightDate);

                // TODO: change calendar to a spinner?

                const api = new BookingAPI();
                if (outbound) {
                    api.getFlightCounts(
                        1, booking.getFromCityId(), booking.getToCityId(),
                        api.toYYYYMMDD(firstDate), api.toYYYYMMDD(lastDate), timezone,
                        processOutboundFlightCounts, showHttpError);
                }
                else {
                    api.getFlightCounts(
                        1, booking.getToCityId(), booking.getFromCityId(),
                        api.toYYYYMMDD(firstDate), api.toYYYYMMDD(lastDate), timezone,
                        processInboundFlightCounts, showHttpError);
                }
            }

            function calculateFirstDate(flightDate) {
                let today = new Date(flightDate);
                let thisWeek = new Date(today);
                thisWeek.setDate(today.getDate() - today.getDay());
                let twoWeeksAgo = new Date(thisWeek);
                twoWeeksAgo.setDate(thisWeek.getDate() - 14);
                return twoWeeksAgo;
            }

            function calculateLastDate(flightDate) {
                let today = new Date(flightDate);
                let thisWeek = new Date(today);
                thisWeek.setDate(today.getDate() - today.getDay());
                let twoWeeksFromNow = new Date(thisWeek);
                twoWeeksFromNow.setDate(thisWeek.getDate() + 14);
                const lastDay = new Date(twoWeeksFromNow);
                lastDay.setDate(lastDay.getDate() + 6);
                return lastDay;
            }

            function buildCalendar(booking, dateString, timezone, outbound, hiddenId) {
                var oldTbody;
                if (outbound) {
                    oldTbody = outboundFlightCalendar.tBodies[0];
                }
                else {
                    oldTbody = inboundFlightCalendar.tBodies[0];
                }
                var tableBody = document.createElement("tbody");

                let today = new Date(dateString);
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec',];

                let thisWeek = new Date(today);
                thisWeek.setDate(today.getDate() - today.getDay());

                let prevWeek = new Date(today);
                prevWeek.setDate(today.getDate() - 7);
                if (outbound) {
                    addHeaderFooterRow(tableBody, 'Prev Week', 'fa-caret-up', "outboundCalendarButtonClicked('"+prevWeek.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                }
                else {
                    addHeaderFooterRow(tableBody, 'Prev Week', 'fa-caret-up', "inboundCalendarButtonClicked('"+prevWeek.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                }

                let twoWeeksAgo = new Date(thisWeek);
                twoWeeksAgo.setDate(thisWeek.getDate() - 14);
                let oneWeekAgo = new Date(thisWeek);
                oneWeekAgo.setDate(thisWeek.getDate() - 7);
                const earlierWeeks = [ twoWeeksAgo, oneWeekAgo ];

                for (let row = 0; row < 2; ++row) {
                    var newRow = tableBody.insertRow(-1);
                    for (let col = 0; col < 7; ++col) {
                        let dow = new Date(earlierWeeks[row]);
                        dow.setDate(earlierWeeks[row].getDate() + col);

                        var button = document.createElement('button');
                        button.setAttribute('type', 'button');
                        button.setAttribute('class', 'btn btn-sm bg-transparent border-0');
                        if (outbound) {
                            button.setAttribute('onclick', "outboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }
                        else {
                            button.setAttribute('onclick', "inboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }

                        var newCell = newRow.insertCell(col);
                        if (col == 0 || col == 6) {
                            if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark bg-opacity-25 text-center');
                            else newCell.setAttribute('class', 'bg-success text-dark bg-opacity-25 text-center');
                        }
                        else {
                            if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark bg-opacity-10 text-center');
                            else newCell.setAttribute('class', 'bg-success text-dark bg-opacity-10 text-center');
                        }

                        generateInnerHtml(button, dow, months, outbound);

                        newCell.style.width = '14%';
                        newCell.appendChild(button);
                    }
                }

                var newRow = tableBody.insertRow(-1);
                for (let col = 0; col < 7; ++col) {
                    let dow = new Date(thisWeek);
                    dow.setDate(thisWeek.getDate() + col);

                    var element;
                    var newCell = newRow.insertCell(col);
                    if (col == today.getDay()) {
                        element = document.createElement('span');
                        if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-warning fw-bold text-dark text-center');
                        else newCell.setAttribute('class', 'bg-warning fw-bold text-dark text-center');
                    }
                    else if (col == 0 || col == 6) {
                        element = document.createElement('button');
                        element.setAttribute('type', 'button');
                        element.setAttribute('class', 'btn btn-sm bg-transparent border-0');
                        if (outbound) {
                            element.setAttribute('onclick', "outboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }
                        else {
                            element.setAttribute('onclick', "inboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }

                        if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark text-center');
                        else newCell.setAttribute('class', 'bg-success text-dark text-center');
                        newCell.setAttribute('style', '--bs-bg-opacity: .35;');
                    }
                    else {
                        element = document.createElement('button');
                        element.setAttribute('type', 'button');
                        element.setAttribute('class', 'btn btn-sm bg-transparent border-0');
                        if (outbound) {
                            element.setAttribute('onclick', "outboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }
                        else {
                            element.setAttribute('onclick', "inboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }

                        if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark text-center');
                        else newCell.setAttribute('class', 'bg-success text-dark text-center');
                        newCell.setAttribute('style', '--bs-bg-opacity: .2;');
                    }

                    generateInnerHtml(element, dow, months, outbound);

                    newCell.style.width = '14%';
                    newCell.appendChild(element);
                }

                let oneWeekFromNow = new Date(thisWeek);
                oneWeekFromNow.setDate(thisWeek.getDate() + 7);
                let twoWeeksFromNow = new Date(thisWeek);
                twoWeeksFromNow.setDate(thisWeek.getDate() + 14);
                const laterWeeks = [ oneWeekFromNow, twoWeeksFromNow ];

                for (let row = 0; row < 2; ++row) {
                    var newRow = tableBody.insertRow(-1);
                    for (let col = 0; col < 7; ++col) {
                        let dow = new Date(laterWeeks[row]);
                        dow.setDate(laterWeeks[row].getDate() + col);

                        var button = document.createElement('button');
                        button.setAttribute('type', 'button');
                        button.setAttribute('class', 'btn btn-sm bg-transparent border-0');
                        if (outbound) {
                            button.setAttribute('onclick', "outboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }
                        else {
                            button.setAttribute('onclick', "inboundCalendarButtonClicked('"+dow.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                        }

                        var newCell = newRow.insertCell(col);
                        if (col == 0 || col == 6) {
                            if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark bg-opacity-25 text-center');
                            else newCell.setAttribute('class', 'bg-success text-dark bg-opacity-25 text-center');
                        }
                        else {
                            if (dow.getMonth() % 2 == 0) newCell.setAttribute('class', 'bg-primary text-dark bg-opacity-10 text-center');
                            else newCell.setAttribute('class', 'bg-success text-dark bg-opacity-10 text-center');
                        }

                        generateInnerHtml(button, dow, months, outbound);

                        newCell.style.width = '14%';
                        newCell.appendChild(button);
                    }
                }

                let nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);
                if (outbound) {
                    addHeaderFooterRow(tableBody, 'Next Week', 'fa-caret-down', "outboundCalendarButtonClicked('"+nextWeek.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                }
                else {
                    addHeaderFooterRow(tableBody, 'Next Week', 'fa-caret-down', "inboundCalendarButtonClicked('"+nextWeek.toISOString()+"', '"+timezone+"', '"+hiddenId+"');");
                }

                oldTbody.parentNode.replaceChild(tableBody, oldTbody);
            }

            function generateInnerHtml(element, dateObject, months, outbound) {
                let flightsCount = getFlightsCountForDate(dateObject, outbound);
                if (flightsCount > 0) {
                    element.innerHTML = '<span>' + dateObject.getDate() + ' ' + months[dateObject.getMonth()] +
                        '<BR><span class="badge rounded-pill bg-success">' + flightsCount + '&nbsp;<i class="fa-solid fa-plane"></i></span></span>';
                }
                else {
                    element.innerHTML = '<span>' + dateObject.getDate() + ' ' + months[dateObject.getMonth()] + '</span>';
                }
            }

            function getFlightsCountForDate(dateObject, outbound) {
                const api = new BookingAPI();
                let dateString = api.toYYYYMMDD(dateObject);                
                if (outbound) {
                    let item = outboundFlightCounts.find(x => x.departureDate == dateString);
                    return item != null ? item.numFlights : 0;
                }
                let item = inboundFlightCounts.find(x => x.departureDate == dateString);
                return item != null ? item.numFlights : 0;
            }

            function processOutboundFlightCounts(json) {
                outboundFlightCounts.push.apply(outboundFlightCounts, json.results);

                if (json.next != null) {
                    let queryParams = json.next.substring(json.next.indexOf('?')+1);
                    const params = new Proxy(new URLSearchParams(queryParams), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                    const api = new BookingAPI();
                    api.getFlightCounts(
                        params.page, params.fromAirport, params.toAirport,
                        params.beginDate, params.endDate, params.timezone,
                        processOutboundFlightCounts, showHttpError);
                }
                else {
                    const booking = new Booking();
                    buildCalendar(booking, leaveDate.value, booking.getTimezone(), true, 'leaveDate');
                }
            }

            function processInboundFlightCounts(json) {
                inboundFlightCounts.push.apply(inboundFlightCounts, json.results);

                if (json.next != null) {
                    let queryParams = json.next.substring(json.next.indexOf('?')+1);
                    const params = new Proxy(new URLSearchParams(queryParams), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                    const api = new BookingAPI();
                    api.getFlightCounts(
                        params.page, params.fromAirport, params.toAirport,
                        params.beginDate, params.endDate, params.timezone,
                        processInboundFlightCounts, showHttpError);
                }
                else {
                    const booking = new Booking();
                    buildCalendar(booking, returnDate.value, booking.getTimezone(), false, 'returnDate');
                }
            }

            function outboundCalendarButtonClicked(date, timezone, hiddenId) {
                const booking = new Booking();
                saveNewFlightDateAndUpdateGui(date, timezone, true, hiddenId);
                fetchFlightCountsOnThisDate(booking, date, timezone, true);
            }

            function inboundCalendarButtonClicked(date, timezone, hiddenId) {
                const booking = new Booking();
                saveNewFlightDateAndUpdateGui(date, timezone, false, hiddenId);
                fetchFlightCountsOnThisDate(booking, date, timezone, false);
            }

            function addHeaderFooterRow(tableBody, text, caretType, onClickString) {
                var row = tableBody.insertRow(-1);

                var cell = row.insertCell(row);
                cell.setAttribute('class', 'text-center');
                cell.setAttribute('colspan', '7');

                var button = document.createElement('button');
                button.setAttribute('type', 'button');
                button.setAttribute('class', 'btn btn-light');
                button.setAttribute('onclick', onClickString);

                button.innerHTML = '<i class="fa-solid ' + caretType + '"></i>&nbsp;&nbsp;' + text + '&nbsp;&nbsp;<i class="fa-solid ' + caretType + '"></i>';

                cell.appendChild(button);
            }

            function updateBookingTripCosts(booking) {
                var outboundFlightCost = getChosenFlightCost('outboundFlightId', 'outboundCost');
                if (outboundFlightCost) {
                    outboundTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + outboundFlightCost;
                }
                else if (booking.hasOutboundFlightCost()) {
                    outboundTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getOutboundFlightCost();
                }
                else {
                    outboundTripCost.innerText = '';
                }

                var inboundFlightCost = getChosenFlightCost('inboundFlightId', 'inboundCost');
                if (inboundFlightCost) {
                    returnTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + inboundFlightCost;
                }
                else if (booking.hasInboundFlightCost()) {
                    returnTripCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getInboundFlightCost();
                }
                else {
                    returnTripCost.innerText = '';
                }
            }

            function insertTableSpinner(flightTableName) {
                var table = document.getElementById(flightTableName);
                var oldTbody = table.tBodies[0];
                var tableBody = document.createElement("tbody");

                var newRow = tableBody.insertRow(-1);
                var newCell = newRow.insertCell(0);
                newCell.setAttribute('colspan', '6');

                var newDiv1 = document.createElement('div');
                newDiv1.setAttribute('class', 'text-center');
                newCell.appendChild(newDiv1);

                var newDiv2 = document.createElement('div');
                newDiv2.setAttribute('class', 'spinner-border');
                newDiv2.setAttribute('role', 'status');
                newDiv1.appendChild(newDiv2);

                var span = document.createElement('span');
                span.setAttribute('class', 'visually-hidden');
                span.innerText = 'Loading...';
                newDiv2.appendChild(span);

                oldTbody.parentNode.replaceChild(tableBody, oldTbody);
            }

            function fetchFlightsOnThisDate(flightTableName, dateObject, timezone, outbound) {
                insertTableSpinner(flightTableName);
                const booking = new Booking();
                searchFlights(1, flightTableName, booking.getFromCityId(), booking.getToCityId(), dateObject, timezone, outbound);
            }

            function searchFlights(currentPage, flightTableName, fromCity, toCity, leaveDate, timezone, outbound) {
                var options = {
                    departureCity: outbound ? fromCity : toCity,
                    arrivalCity: outbound ? toCity : fromCity,
                    departureDate: leaveDate,
                    timezone: timezone
                };

                const api = new BookingAPI();
                api.searchFlights(options, currentPage, function (json) {
                    setTimeout(function () {
                        const booking = new Booking();

                        var table = document.getElementById(flightTableName);
                        var oldTbody = table.tBodies[0];
                        var tableBody = document.createElement("tbody");

                        json.results.forEach(x => {
                            var newRow = tableBody.insertRow(-1);
                            var flightIdName = (outbound ? 'outboundFlightId' : 'inboundFlightId') + x.id;
                            var aeroplaneIdName = (outbound ? 'outboundAeroplaneId' : 'inboundAeroplaneId') + x.id;

                            var radio = document.createElement('input');
                            radio.setAttribute('type', 'radio');
                            radio.setAttribute('class', 'form-check-label');
                            radio.setAttribute('id', flightIdName);
                            radio.setAttribute('name', flightIdName);
                            if (outbound) {
                                radio.onchange = outboundRadioButtonClicked;
                                if (x.id == booking.getOutboundFlightId()) {
                                    radio.checked = true;
                                }
                            }
                            else {
                                radio.onchange = inboundRadioButtonClicked;
                                if (x.id == booking.getInboundFlightId()) {
                                    radio.checked = true;
                                }
                            }
                            var newCell = newRow.insertCell(0);
                            newCell.appendChild(radio);

                            var link = document.createElement('a');
                            link.setAttribute('href', "/info/viewAeroplane.html?id=" + x.aeroplane.id);
                            link.setAttribute('id', aeroplaneIdName);
                            link.setAttribute('name', aeroplaneIdName);
                            link.innerText = x.aeroplane.make_model;
                            newCell = newRow.insertCell(1);
                            newCell.appendChild(link);

                            newCell = newRow.insertCell(2);
                            var span = document.createElement('span');
                            span.setAttribute('id', (outbound ? 'outboundTime' : 'inboundTime') + x.id);
                            span.appendChild(document.createTextNode(toLocaleTime(x.departure_date_time_utc, x.departure_airport.timezone)));
                            newCell.appendChild(span);

                            var small = document.createElement('small');
                            small.setAttribute('class', 'text-muted fst-italic');
                            small.setAttribute('style', 'font-size: x-small');
                            small.innerText = ' ' + x.departure_airport.timezone + ' time';
                            newCell.appendChild(small);

                            newCell = newRow.insertCell(3);
                            newCell.appendChild(document.createTextNode(toLocaleTime(x.arrival_date_time_utc, x.arrival_airport.timezone)));

                            small = document.createElement('small');
                            small.setAttribute('id', (outbound ? 'outboundTimezone' : 'inboundTimezone') + x.id);
                            small.setAttribute('class', 'text-muted fst-italic');
                            small.setAttribute('style', 'font-size: x-small');
                            small.innerText = ' ' + x.arrival_airport.timezone + ' time';
                            newCell.appendChild(small);

                            newCell = newRow.insertCell(4);
                            var s = '';
                            var h = Math.floor(x.flight_time_mins/60);
                            if (h > 0) {
                                s += h + 'h ';
                            }
                            newCell.appendChild(document.createTextNode(s + (x.flight_time_mins%60) + 'm'));

                            newCell = newRow.insertCell(5);
                            span = document.createElement('span');
                            span.appendChild(document.createTextNode('$'));
                            newCell.appendChild(span);

                            span = document.createElement('span');
                            span.setAttribute('id', (outbound ? 'outboundCost' : 'inboundCost') + x.id);
                            span.setAttribute('name', (outbound ? 'outboundCost' : 'inboundCost') + x.id);
                            span.appendChild(document.createTextNode(x.cost_dollars));
                            newCell.appendChild(span);
                        });

                        if (json.results.length == 0) {
                            var newRow = tableBody.insertRow(-1);

                            var newCell = newRow.insertCell(0);
                            newCell.setAttribute('colspan', '6');

                            var div1 = document.createElement('div');
                            div1.setAttribute('class', 'row');

                            var div2 = document.createElement('div');
                            div2.setAttribute('class', 'col text-center');

                            var span = document.createElement('span');
                            span.setAttribute('class', 'fst-italic');
                            span.innerText = 'There are no flights from ';
                            div2.appendChild(span);

                            span = document.createElement('span');
                            span.setAttribute('class', 'fst-italic fw-bold text-success');
                            span.innerText = outbound ? booking.getFromCityName() : booking.getToCityName();
                            div2.appendChild(span);

                            span = document.createElement('span');
                            span.setAttribute('class', 'fst-italic');
                            span.innerText = ' to ';
                            div2.appendChild(span);

                            span = document.createElement('span');
                            span.setAttribute('class', 'fst-italic fw-bold text-success');
                            span.innerText = outbound ? booking.getToCityName() : booking.getFromCityName();
                            div2.appendChild(span);

                            span = document.createElement('span');
                            span.setAttribute('class', 'fst-italic');
                            span.innerText = ' on this date.';
                            div2.appendChild(span);

                            div1.appendChild(div2);                            
                            newCell.appendChild(div1);
                        }

                        oldTbody.parentNode.replaceChild(tableBody, oldTbody);

                        enableOrDisableNextButton();
                        drawNewTotalCostOnGui();

                        if (outbound) {
                            drawNewFlightTimeOnGui(fromCityTime, true);
                        }
                        else {
                            drawNewFlightTimeOnGui(toCityTime, false);
                        }
                    }, 500);
                },
                showHttpError);
            }

            function showGeneralError(message) {
                errorMessageTitle.innerText = 'Error';
                errorMessageBody.innerHTML = message;
                showError();
            }

            function showHttpError(code, json) {
                errorMessageTitle.innerText = 'Error Received';
                errorMessageBody.innerHTML = 'The server returned HTTP code ' + code + '.<BR><BR>' + javascriptObjectToDivs(json);
                showError();
            }

            function javascriptObjectToDivs(object) {
                let html = '';
                for (var key of Object.keys(object)) {
                    html = '<div class="row"><div class="col">' + key + ': ' + object[key] + '</div></div>\r\n';
                }
                return html;
            }

            function showError() {
                const toastLiveExample = document.getElementById('responseCodePopup');
                const toast = new bootstrap.Toast(toastLiveExample);
                toast.show();
            }

            function outboundRadioButtonClicked(event) {
                uncheckOtherRadioButtons('outboundFlightId', event);
                enableOrDisableNextButton();
                drawNewFlightTimeOnGui(fromCityTime, true);
                const booking = new Booking();
                updateBookingTripCosts(booking);
                drawNewTotalCostOnGui();
            }

            function inboundRadioButtonClicked(event) {
                uncheckOtherRadioButtons('inboundFlightId', event);
                enableOrDisableNextButton();
                drawNewFlightTimeOnGui(toCityTime, false);
                const booking = new Booking();
                updateBookingTripCosts(booking);
                drawNewTotalCostOnGui();
            }

            function uncheckOtherRadioButtons(namePrefix, event) {
                if (!event.currentTarget.checked) {
                    return;
                }
                var radioButtons = document.getElementsByTagName('input');
                for (var i = 0; i < radioButtons.length; ++i) {
                    var x = radioButtons[i];
                    if (x.getAttribute('type') == 'radio' && x.name.substring(0, namePrefix.length) == namePrefix) {
                        x.checked = (event.currentTarget.id == x.id);
                    }
                }
            }

            function drawNewFlightTimeOnGui(updateThisSpan, outbound) {
                var flightPrefix = '', timePrefix = '', timezonePrefix = '';
                if (outbound) {
                    flightPrefix = 'outboundFlightId';
                    timePrefix = 'outboundTime';
                    timezonePrefix = 'outboundTimezone';
                }
                else {
                    flightPrefix = 'inboundFlightId';
                    timePrefix = 'inboundTime';
                    timezonePrefix = 'inboundTimezone';
                }

                var timePrefixSpan = getChosenFlightValue('span', flightPrefix, timePrefix);
                var timezonePrefixSpan = getChosenFlightValue('small', flightPrefix, timezonePrefix);

                if (timePrefixSpan != null && timezonePrefixSpan != null) {
                    updateThisSpan.innerHTML =
                            '<span>' + timePrefixSpan + '</span> ' +
                            '<small class="text-muted fst-italic" style="font-size: x-small">' + timezonePrefixSpan + '</small>';
                }
                else {
                    updateThisSpan.innerHTML = '';
                }
            }

            function drawNewTotalCostOnGui() {
                var cost = 0;

                var outboundCost = getChosenFlightValue('span', 'outboundFlightId', 'outboundCost');
                if (outboundCost != null) {
                    cost += parseInt(outboundCost);
                }

                const booking = new Booking();
                if (booking.isReturnTrip()) {
                    var inboundCost = getChosenFlightValue('span', 'inboundFlightId', 'inboundCost');
                    if (inboundCost != null) {
                        cost += parseInt(inboundCost);
                    }
                }

                cost = parseInt(numPassengers.innerText) * cost;

                if (booking.hasRentalCarCost()) {
                    cost += calcNumDays(booking) * parseInt(booking.getRentalCarCost());
                }

                if (booking.hasTravelInsuranceCost()) {
                    cost += parseInt(booking.getNumPassengers()) * parseInt(booking.getTravelInsuranceCost());
                }

                totalCost.innerText = cost;
            }

            function calcNumDays(booking) {
                const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
                const firstDate = new Date(booking.getLeaveDate());
                const secondDate = new Date(booking.getReturnDate());
                return Math.round(Math.abs((firstDate - secondDate) / oneDay));
            }

            function enableOrDisableNextButton() {
                var outboundChecked = isRadioButtonChecked('outboundFlightId');

                var inboundChecked = true;
                const booking = new Booking();
                if (booking.isReturnTrip()) {
                    inboundChecked = isRadioButtonChecked('inboundFlightId');
                }

                nextButton.disabled = !outboundChecked || !inboundChecked;
                if (nextButton.disabled) {
                    nextButton.setAttribute('class', 'btn btn-primary mb-4 disabled');
                }
                else {
                    nextButton.setAttribute('class', 'btn btn-primary mb-4');
                }
            }

            function isRadioButtonChecked(namePrefix) {
                var radioButtons = document.getElementsByTagName('input');
                for (var i = 0; i < radioButtons.length; ++i) {
                    var x = radioButtons[i];
                    if (x.getAttribute('type') == 'radio' && x.name.substring(0, namePrefix.length) == namePrefix && x.checked) {
                        return true;
                    }
                }
                return false;
            }

            function getChosenFlightId(namePrefix) {
                var radioButtons = document.getElementsByTagName('input');
                for (var i = 0; i < radioButtons.length; ++i) {
                    var x = radioButtons[i];
                    if (x.getAttribute('type') == 'radio' && x.name.substring(0, namePrefix.length) == namePrefix && x.checked) {
                        return x.name.substring(namePrefix.length);
                    }
                }
                return null;
            }

            function getChosenAeroplaneId(namePrefix, flightId) {
                var anchors = document.getElementsByTagName('a');
                for (var i = 0; i < anchors.length; ++i) {
                    if (anchors[i].name.substring(0, namePrefix.length) == namePrefix && anchors[i].name.substring(namePrefix.length) == flightId) {
                        const re = /\?id=(.+)$/;
                        const id = re.exec(anchors[i].href);
                        if (id != null && id.length > 1) {
                            return parseInt(id[1]);
                        }
                    }
                }
                return null;
            }

            function getChosenFlightCost(flightNamePrefix, spanValuePrefix) {
                return getChosenFlightValue('span', flightNamePrefix, spanValuePrefix);
            }

            function getChosenFlightValue(tagName, flightNamePrefix, spanValuePrefix) {
                var chosenFlightId = getChosenFlightId(flightNamePrefix);
                if (chosenFlightId == null) {
                    return null;
                }

                var spans = document.getElementsByTagName(tagName);
                for (var i = 0; i < spans.length; ++i) {
                    if (spans[i].id.substring(0, spanValuePrefix.length) == spanValuePrefix) {
                        var spanFlightId = spans[i].id.substring(spanValuePrefix.length);
                        if (spanFlightId == chosenFlightId) {
                            return spans[i].innerText;
                        }
                    }
                }
                return null;
            }

            function toLocaleTime(dateTime, timezone) {
                return new Date(dateTime).toLocaleTimeString([],
                                {
                                    timeZone: timezone,
                                    hour: 'numeric',
                                    minute: '2-digit',
                                    hour12: true
                                });
            }

            function saveNewFlightDateAndUpdateGui(dateString, timezone, outbound, hiddenId) {
                var dateObject = new Date(dateString);
                saveNewFlightDateInBooking(dateObject, timezone, outbound, hiddenId);

                if (outbound) {
                    fetchFlightsOnThisDate('departsFlightTable', dateObject, timezone, true);
                    drawNewFlightTimeOnGui(fromCityTime, true);
                }
                else {
                    fetchFlightsOnThisDate('arrivesFlightTable', dateObject, timezone, false);
                    drawNewFlightTimeOnGui(toCityTime, false);
                }

                nextButton.disabled = true;
                drawNewTotalCostOnGui();
            }

            function saveNewFlightDateInBooking(dateObject, timezone, outbound, hiddenId) {
                const api = new BookingAPI();
                const booking = new Booking();
                if (outbound) {
                    fromCityDate.innerText = toLocaleDate(new Date(dateObject), timezone);
                    booking.setLeaveDate(api.toYYYYMMDD(dateObject));
                }
                else {
                    toCityDate.innerText = toLocaleDate(new Date(dateObject), timezone);
                    booking.setReturnDate(api.toYYYYMMDD(dateObject));
                }

                var hidden = document.getElementById(hiddenId);
                hidden.value = api.toYYYYMMDD(dateObject);
            }

            function toLocaleDate(dateTime, timezone) {
                return new Date(dateTime).toLocaleDateString([],
                                {
                                    timeZone: timezone,
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short'
                                });
            }

            function previousButtonClicked() {
                window.location.href = "/booking/bookAFlight.html?source=session";
            }

            function nextButtonClicked() {
                const booking = new Booking();
                if (booking.isReturnTrip()) {
                    const leavesWhen = new Date(leaveDate.value);
                    const returnsWhen = new Date(returnDate.value);
                    if (returnsWhen <= leavesWhen) {
                        showGeneralError('The return date must be after the leave date.')
                        return false;
                    }
                }

                var outboundFlightId = getChosenFlightId('outboundFlightId');
                var outboundAeroplaneId = getChosenAeroplaneId('outboundAeroplaneId', outboundFlightId);
                var outboundFlightCost = getChosenFlightCost('outboundFlightId', 'outboundCost');

                var inboundFlightId = getChosenFlightId('inboundFlightId');
                var inboundAeroplaneId = getChosenAeroplaneId('inboundAeroplaneId', inboundFlightId);
                var inboundFlightCost = getChosenFlightCost('inboundFlightId', 'inboundCost');

                booking.setOutboundFlightId(outboundFlightId);
                booking.setOutboundAeroplaneId(outboundAeroplaneId);
                booking.setOutboundFlightCost(outboundFlightCost);

                booking.setInboundFlightId(inboundFlightId == null ? '' : inboundFlightId);
                booking.setInboundAeroplaneId(inboundAeroplaneId == null ? '' : inboundAeroplaneId);
                booking.setInboundFlightCost(inboundFlightCost == null ? '' : inboundFlightCost);

                booking.setTotalCost(totalCost.innerText);
                booking.setLeaveTime(fromCityTime.innerText);
                booking.setReturnTime(toCityTime.innerText);

                window.location.href = "/booking/passengerDetails.html";
            }
        </SCRIPT>
    </HEAD>
    <BODY>
        <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <DIV class="container-fluid">
                <A class="navbar-brand" href="/">Home</A>
                <BUTTON class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <SPAN class="navbar-toggler-icon"/>
                </BUTTON>
                <DIV class="collapse navbar-collapse" id="navbarCollapse">
                    <UL class="navbar-nav me-auto mb-2 mb-md-0">
                        <LI class="nav-item">
                            <A class="nav-link active" href="/info/listFlights.html">Flights</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/info/listAeroplanes.html">Aeroplanes</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/user/editUser.html">User</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/booking/listBookings.html">Bookings</A>
                        </LI>
                        <LI class="nav-item">
                            <BUTTON class="btn btn-success" type="button" onclick="window.location.href = '/booking/bookAFlight.html'">
                                <i class="fa-solid fa-plane"></i>&nbsp;Book a Flight</BUTTON>
                        </LI>
                    </UL>
                </DIV>
            </DIV>
        </NAV>
        <MAIN class="container">
            <HEADER class="pb-3 mt-3 mb-5 border-bottom">
                <H1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <i class="fa-solid fa-plane"></i>
                    <SPAN>&nbsp;Book a Flight</SPAN>
                </H1>
            </HEADER>

            <DIV class="row mb-5">
                <ul class="wizard-progress">
                    <li class="wizard-step completed" id="searchStep" onclick="window.location.href='/booking/bookAFlight.html?source=session';">Search</li>
                    <li class="wizard-step active" id="searchFlights">Flights</li>
                    <li class="wizard-step" id="searchPassengers">Passengers</li>
                    <li class="wizard-step" id="searchExtras">Extras</li>
                    <li class="wizard-step" id="searchSeats">Seats</li>
                    <li class="wizard-step" id="searchConfirm">Confirm</li>
                    <li class="wizard-step" id="searchInvoice">Invoice</li>
                </ul>
            </DIV>

            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-2 text-primary">Available Flights</h4>

                    <div class="fs-5 mb-4">
                        Select your flight to <span class="text-success fw-bold text-decoration-underline" id="toCityName1"></span>
                    </div>

                    <input type="hidden" id="leaveDate"/>
                    <div class="row justify-content-center">
                        <div class="col-10">
                            <table id="outboundFlightCalendar" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col">Sun</th><th scope="col">Mon</th><th scope="col">Tue</th><th scope="col">Wed</th>
                                        <th scope="col">Thu</th><th scope="col">Fri</th><th scope="col">Sat</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <table id="departsFlightTable" class="table table-striped table-hover mb-5">
                        <thead>
                            <tr>
                                <th scope="col">&nbsp;</th>
                                <th scope="col">Aeroplane</th>
                                <th scope="col">Departs</th>
                                <th scope="col">Arrives</th>
                                <th scope="col">Flight Time</th>
                                <th scope="col">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <span id="returnFlightGUI">
                        <div class="my-5">&nbsp;</div>

                        <div class="fs-5 mt-5 mb-4">
                            Select your return flight to <span class="text-success fw-bold text-decoration-underline" id="fromCityName1"></span>
                        </div>

                        <input type="hidden" id="returnDate"/>
                        <div class="row justify-content-center">
                            <div class="col-10">
                                <table id="inboundFlightCalendar" class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th scope="col">Sun</th><th scope="col">Mon</th><th scope="col">Tue</th><th scope="col">Wed</th>
                                            <th scope="col">Thu</th><th scope="col">Fri</th><th scope="col">Sat</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
    
                        <table id="arrivesFlightTable" class="table table-striped table-hover mb-5">
                            <thead>
                                <tr>
                                    <th scope="col">&nbsp;</th>
                                    <th scope="col">Aeroplane</th>
                                    <th scope="col">Departs</th>
                                    <th scope="col">Arrives</th>
                                    <th scope="col">Flight Time</th>
                                    <th scope="col">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6">
                                        <div class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </span>

                    <div class="row justify-content-between">
                        <div class="col col-md-auto">
                            <button class="btn btn-secondary mb-4" onclick="previousButtonClicked();">
                                <i class="fa-solid fa-circle-arrow-left"></i>&nbsp;Previous
                            </button>
                        </div>
                        <div class="col col-md-auto">
                            <button class="btn btn-primary mb-4 disabled" id="nextButton" onclick="nextButtonClicked();">
                                Next&nbsp;<i class="fa-solid fa-circle-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-4 order-md-last">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-primary">Your Booking</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <span class="col">Num Passengers</span>
                                <span class="col text-end" id="numPassengers">1</span>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col"><h5 class="card-title">Outbound trip</h5></div>
                                <div class="col-md-auto text-end"><span id="outboundTripCost"></span></div>
                            </div>
                            <span class="text-success fw-bold" id="fromCityName2"></span> to <span class="text-success fw-bold" id="toCityName2"></span>
                            <p class="card-text">
                                <span id="fromCityDate"></span>&nbsp;<span id="fromCityTime"></span>
                            </p>
                            <span id="returnFlightBookingGUI">
                                <hr>
                                <div class="row">
                                    <div class="col"><h5 class="card-title">Return trip</h5></div>
                                    <div class="col-md-auto text-end"><span id="returnTripCost"></span></div>
                                </div>
                                <span class="text-success fw-bold" id="toCityName3"></span> to <span class="text-success fw-bold" id="fromCityName3"></span>
                                <p class="card-text">
                                    <span id="toCityDate"></span>&nbsp;<span id="toCityTime"></span>
                                </p>
                            </span>
                            <span id="extrasBookingGUI">
                                <hr>
                                <h5 class="card-title">Extras</h5>
                                <div class="row">
                                    <span class="col" id="rentalCarBookingGUI"></span>
                                    <span class="col-md-auto text-end" id="rentalCarCostBookingGUI"></span>
                                </div>
                                <div class="row">
                                    <span class="col" id="travelInsuranceBookingGUI"></span>
                                    <span class="col-md-auto text-end" id="travelInsuranceCostBookingGUI"></span>
                                </div>
                            </span>
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <span class="col">Total (NZD)</span>
                                <strong class="col text-end">$<span id="totalCost">0</span></strong>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="javascript:;">Privacy</A> &middot; <A href="javascript:;">Terms</A>
                </P>
                <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>
        </MAIN>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="responseCodePopup" class="toast fade" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger">
                    <strong class="me-auto text-white" id="errorMessageTitle"></strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorMessageBody"></div>
            </div>
        </div>

        <SCRIPT src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
        </SCRIPT>
    </BODY>
</HTML>
