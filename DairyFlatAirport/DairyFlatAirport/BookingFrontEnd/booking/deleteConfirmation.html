<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>
        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"/>
        <LINK rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>

        <SCRIPT type="text/javascript">
            window.onload = function() {
                const api = new BookingAPI();
                if (!api.isSignedIn()) {
                    api.signIn(window.location.href);
                }

                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                api.getBooking(params.id,
                    function (json) {
                        setTimeout(function () {
                            spinnerLoading.style.display = "none";
                            passengers.style.display = "";

                            document.getElementById("bookingNumber").innerText = json.number;
                            document.getElementById("createdBy").innerText = json.created_by.username;

                            json.passengers.forEach(x => {
                                var passengersList = document.getElementById("passengers");
                                var listItem = document.createElement("li");
                                listItem.setAttribute("class", "list-group-item");
                                var s = "";
                                if (x.title != null) {
                                    s += x.title + " ";
                                }
                                listItem.innerText = s + x.first_name + " " + x.second_name;
                                passengersList.appendChild(listItem);
                            });

                            json.flightLegs.forEach(x => {
                                var passengersList = document.getElementById("flightLegs");
                                var listItem = document.createElement("li");
                                listItem.setAttribute("class", "list-group-item");
                                listItem.innerText = x.number + ", " + x.departure_airport.name + " -> " + x.arrival_airport.name;
                                passengersList.appendChild(listItem);
                            });

                            if (json.travelInsurance != null) {
                                document.getElementById("travelInsurance").innerText = json.travelInsurance.title;
                            }
                            else {
                                document.getElementById("travelInsurance").innerText = "-";
                            }
                            if (json.rentalCar != null) {
                                document.getElementById("rentalCar").innerText = json.rentalCar.type + ", " + json.rentalCar.make + " " + json.rentalCar.model;
                            }
                            else {
                                document.getElementById("rentalCar").innerText = "-";
                            }
                        }, 500);
                    },
                    showHttpError
                );

                updateSignInGui();
            }

            function updateSignInGui() {
                setSignInButtonText();
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    signedInUserDisplayName.innerText = api.signedInUserDisplayName;
                    signedInUserSpan.style.display = '';
                    api.getSignedInUser(
                        function (json) {
                            signedInUserDisplayName.innerText = api.signedInUserDisplayName;
                            signedInUserSpan.style.display = '';
                        },
                        showHttpError
                    );
                }
                else {
                    signedInUserDisplayName.innerText = '';
                    signedInUserSpan.style.display = 'none';
                }
            }

            function signInOrOut() {
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    api.signOut();
                    signedInUserSpan.style.display = 'none';
                }
                else {
                    api.signIn(window.location.href);
                }
                setSignInButtonText();
            }

            function setSignInButtonText() {
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    signInOrOutButton.setAttribute('class', 'btn btn-success');
                    signInOrOutButton.innerText = 'Sign Out';
                }
                else {
                    signInOrOutButton.setAttribute('class', 'btn btn-primary');
                    signInOrOutButton.innerText = 'Sign In';
                    signedInUserDisplayName.innerText = '';
                }
            }

            function deleteBooking() {
                document.getElementById("deleteConfirmationTitle").innerText = "Deleting...";
                document.getElementById("deleteText").style.display = "none";
                document.getElementById("cancelButton").disabled = true;
                document.getElementById("deleteButton").disabled = true;
                document.getElementById("deleteSpinner").style.display = "";

                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                const api = new BookingAPI();
                api.deleteBooking(params.id,
                    function(json) {
                        setTimeout(function() {
                            document.location.href = "/booking/listBookings.html";
                        }, 500);
                    },
                    function(code, json) {
                        document.getElementById("cancelButton").disabled = false;
                        document.getElementById("deleteButton").disabled = false;
                        document.getElementById("deleteSpinner").style.display = "none";
                        showHttpError(code, json);
                    });
            }

            function showHttpError(code, json) {
                errorMessageTitle.innerText = 'Error Received';
                errorMessageBody.innerHTML = 'The server returned HTTP code ' + code + '.<BR><BR>' + javascriptObjectToDivs(json);
                showError();
            }

            function javascriptObjectToDivs(object) {
                let html = '';
                for (var key of Object.keys(object)) {
                    html = '<div class="row"><div class="col">' + key + ': ' + object[key] + '</div></div>\r\n';
                }
                return html;
            }

            function showError() {
                const toastLiveExample = document.getElementById('responseCodePopup');
                const toast = new bootstrap.Toast(toastLiveExample);
                toast.show();
            }
        </SCRIPT>

    </HEAD>
    <BODY>

        <HEADER>
            <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
                <DIV class="container-fluid">
                    <A class="navbar-brand" href="/">Home</A>
                    <BUTTON class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <SPAN class="navbar-toggler-icon"/>
                    </BUTTON>
                    <DIV class="collapse navbar-collapse" id="navbarCollapse">
                        <UL class="navbar-nav me-auto mb-2 mb-md-0">
                            <LI class="nav-item">
                                <A class="nav-link" href="/info/listFlights.html">Flights</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link" href="/info/listAeroplanes.html">Aeroplanes</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link" href="/user/editUser.html">User</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link active" href="/booking/listBookings.html">Bookings</A>
                            </LI>
                            <LI class="nav-item">
                                <BUTTON class="btn btn-success" type="button" onclick="window.location.href = '/booking/bookAFlight.html'">
                                    <i class="fa-solid fa-plane"></i>&nbsp;Book a Flight</BUTTON>
                            </LI>
                        </UL>
                        <div class="d-flex align-items-center">
                            <span id="signedInUserSpan" class="text-light" style="display: none;">Signed in as <span class="text-primary me-3" id="signedInUserDisplayName"></span></span>
                            <button class="btn btn-success" id="signInOrOutButton" onclick="signInOrOut();">Sign In/Out</button>
                        </div>
                    </DIV>
                </DIV>
            </NAV>
        </HEADER>

        <MAIN class="container">

            <div class="row justify-content-center mt-5">
                <div class="col-3 text-center">
                    <h2 class="fw-bold my-5">Delete Booking</h2>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-6">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <h5>Booking</h5>
                            <div>
                                <b>Number:</b>&nbsp;<span id="bookingNumber"></span>
                            </div>
                            <div>
                                <b>Created By:</b>&nbsp;<span id="createdBy"></span>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5>Passengers</h5>
                            <div class="text-center" id="spinnerLoading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush" id="passengers" style="display: none;">
                            </ul>
                        </li>
                        <li class="list-group-item">
                            <h5>Flight Legs</h5>
                            <ul class="list-group list-group-flush" id="flightLegs">
                            </ul>
                        </li>
                        <li class="list-group-item">
                            <h5>Travel Insurance</h5>
                            <span id="travelInsurance"></span>
                        </li>
                        <li class="list-group-item">
                            <h5>Rental Car</h5>
                            <span id="rentalCar"></span>
                        </li>
                    </ul>
                </div>
                <div class="row justify-content-center">
                    <div class="col-2">
                        <button type="button" class="btn btn-danger mt-5 w-100" data-bs-toggle="modal" data-bs-target="#finalConfirmation">
                            <i class="fa-solid fa-trash"></i>&nbsp;Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="modal fade" id="finalConfirmation" tabindex="-1" aria-labelledby="deleteConfirmationTitle" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteConfirmationTitle">Are you sure?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                        </div>
                        <div class="modal-body">
                            <p id="deleteText">This action cannot be undone. The booking will be <b>permanently</b> deleted.</p>
                            <div class="text-center" id="deleteSpinner" style="display: none;">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Deleting...</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="deleteButton" onclick="deleteBooking()"><i class="fa-solid fa-trash"></i>&nbsp;Confirm</button>
                            <button type="button" class="btn btn-secondary" id="cancelButton" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </MAIN>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="responseCodePopup" class="toast fade" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger">
                    <strong class="me-auto text-white" id="errorMessageTitle"></strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorMessageBody"></div>
            </div>
        </div>

        <FOOTER class="container mt-5 text-center">
            <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
            </P>
            <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
            </P>
        </FOOTER>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    </BODY>
</HTML>
