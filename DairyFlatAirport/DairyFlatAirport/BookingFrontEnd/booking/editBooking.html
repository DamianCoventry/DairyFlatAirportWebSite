<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
              crossorigin="anonymous"/>

        <LINK href="/style/grid.css"
              rel="stylesheet"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>

        <SCRIPT type="text/javascript">
            window.onload = function() {
                const params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });

                var link = document.getElementById("deleteBooking");
                link.setAttribute('href', "/booking/deleteConfirmation.html?id=" + params.id);

                const api = new BookingAPI();
                api.getBooking(params.id,
                    function (json) {
                        document.getElementById("number").value = json.number;
                        document.getElementById("createdBy").value = json.created_by.username;
                        if (json.travelInsurance == null) {
                            document.getElementById("travelInsurance").value = "-";
                        }
                        else {
                            document.getElementById("travelInsurance").value = json.travelInsurance.title;
                        }
                        if (json.rentalCar == null) {
                            document.getElementById("rentalCar").value = "-";
                        }
                        else {
                            document.getElementById("rentalCar").value = json.rentalCar.make + " " + json.rentalCar.model;
                        }

                        var table = document.getElementById("passengersTable");
                        var oldTbody = table.tBodies[0];
                        var newTbody = document.createElement("tbody");

                        json.passengers.forEach(x => {
                            var newRow = newTbody.insertRow(-1);

                            newCell = newRow.insertCell(0);
                            var s = "";
                            if (x.title != null) {
                                s += x.title + " ";
                            }
                            newCell.appendChild(document.createTextNode(s + x.first_name + " " + x.second_name));

                            newCell = newRow.insertCell(1);
                            newCell.appendChild(document.createTextNode(x.email_address == null ? "-" : x.email_address));

                            newCell = newRow.insertCell(2);
                            newCell.appendChild(document.createTextNode(x.phone_number == null ? "-" : x.phone_number));

                            newCell = newRow.insertCell(3);
                            newCell.appendChild(document.createTextNode(x.special_assistance == null ? "-" : x.special_assistance));
                        });

                        oldTbody.parentNode.replaceChild(newTbody, oldTbody);

                        var table = document.getElementById("flightsTable");
                        var oldTbody = table.tBodies[0];
                        var newTbody = document.createElement("tbody");

                        json.flightLegs.forEach(x => {
                            var newRow = newTbody.insertRow(-1);

                            var link = document.createElement('a');
                            link.setAttribute('href', "/info/viewFlight.html?id=" + x.id);
                            link.innerText = x.number;
                            var newCell = newRow.insertCell(0);
                            newCell.appendChild(link);

                            link = document.createElement('a');
                            link.setAttribute('href', "/info/viewAeroplane.html?id=" + x.aeroplane);
                            link.innerText = x.aeroplane;
                            newCell = newRow.insertCell(1);
                            newCell.appendChild(link);

                            newCell = newRow.insertCell(2);
                            // TODO: format departure_time_of_day nicely
                            // TODO: calculate correct timezone
                            var departs = x.departure_airport + " " + x.departure_time_of_day;
                            newCell.appendChild(document.createTextNode(departs));

                            newCell = newRow.insertCell(3);
                            // TODO: calculate arrival time, in correct timezone
                            newCell.appendChild(document.createTextNode(x.arrival_airport));

                            newCell = newRow.insertCell(4);
                            newCell.appendChild(document.createTextNode(x.flight_time_minutes));

                            newCell = newRow.insertCell(5);
                            var daysOfWeek = "";
                            if (x.departs_sun === true) daysOfWeek += "Sun,"
                            if (x.departs_mon === true) daysOfWeek += "Mon,"
                            if (x.departs_tue === true) daysOfWeek += "Tue,"
                            if (x.departs_wed === true) daysOfWeek += "Wed,"
                            if (x.departs_thu === true) daysOfWeek += "Thu,"
                            if (x.departs_fri === true) daysOfWeek += "Fri,"
                            if (x.departs_sat === true) daysOfWeek += "Sat,"
                            if (daysOfWeek === "Mon,Tue,Wed,Thu,Fri,") {
                                daysOfWeek = "Mon-Fri,"
                            }
                            newCell.appendChild(document.createTextNode(daysOfWeek.slice(0, -1))); // remove trailing ',' character
                        });

                        oldTbody.parentNode.replaceChild(newTbody, oldTbody);
                    },
                    function(code, json) {
                        document.getElementById("number").value = "code: " + code + ", message: " + json.detail;
                    });
            }
        </SCRIPT>

    </HEAD>
    <BODY>
        <HEADER>
            <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
                <DIV class="container-fluid">
                    <A class="navbar-brand"
                       href="/">Home</A>
                    <BUTTON class="navbar-toggler"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#navbarCollapse"
                            aria-controls="navbarCollapse"
                            aria-expanded="false"
                            aria-label="Toggle navigation">
                        <SPAN class="navbar-toggler-icon"/>
                    </BUTTON>
                    <DIV class="collapse navbar-collapse"
                         id="navbarCollapse">
                        <UL class="navbar-nav me-auto mb-2 mb-md-0">
                            <LI class="nav-item">
                                <A class="nav-link active"
                                   href="/info/listFlights.html">Flights</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link"
                                   href="/info/listAeroplanes.html">Aeroplanes</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link"
                                   href="/user/editUser.html">User</A>
                            </LI>
                            <LI class="nav-item">
                                <A class="nav-link"
                                   href="/booking/listBookings.html">Bookings</A>
                            </LI>
                            <LI class="nav-item">
                                <BUTTON class="btn btn-primary"
                                        type="button"
                                        onclick="window.location.href = '/booking/bookAFlight.html'">Book a flight</BUTTON>
                            </LI>
                        </UL>
                        <FORM class="d-flex">
                            <INPUT class="form-control me-2"
                                   type="search"
                                   placeholder="Search"
                                   aria-label="Search"/>
                            <BUTTON class="btn btn-success"
                                    type="submit"
                                    onclick="alert('TODO');">Search</BUTTON>
                        </FORM>
                    </DIV>
                </DIV>
            </NAV>
        </HEADER>

        <MAIN class="container">

            <header class="pb-3 mb-5 border-bottom">
                <h1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <svg class="bi" width="32" height="32" fill="currentColor">
                        <use xlink:href="/image/bootstrap-icons.svg#calendar3"/>
                    </svg>
                    <span>&nbsp;Booking</span>
                </h1>
            </header>

            <FORM>
                <div class="row justify-content-end">
                    <div class="col-2">
                        <a class="form-control btn btn-danger" id="deleteBooking" href="#"/>Delete Booking</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                      <label for="tailNumber">Number</label>
                      <input type="text" class="form-control" id="number" placeholder="Number" readonly>
                    </div>
                    <div class="col">
                        <label for="makeModel">Created By</label>
                        <input type="text" class="form-control" id="createdBy" placeholder="Created By" readonly>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                      <label for="departsDateTime">Travel Insurance</label>
                      <input type="text" class="form-control" id="travelInsurance" placeholder="Travel Insurance" readonly>
                    </div>
                    <div class="col">
                        <label for="arrivesDateTime">Rental Car</label>
                        <input type="text" class="form-control" id="rentalCar" placeholder="Rental Car" readonly>
                    </div>
                </div>
                <BR/>
            </FORM>

            <h4 class="mb-3 mt-4">Passengers</h4>
            <table id="passengersTable" class="table table-striped">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Phone</th>
                    <th scope="col">Special Assistance</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h4 class="mb-3 mt-5">Flight Legs</h4>
            <table id="flightsTable" class="table table-striped">
                <thead>
                  <tr>
                    <th scope="col">Flight</th>
                    <th scope="col">Aeroplane</th>
                    <th scope="col">Departs</th>
                    <th scope="col">Arrives</th>
                    <th scope="col">Flight Time (mins)</th>
                    <th scope="col">Days of Week</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
 
            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
                </P>
                <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>
        </MAIN>

    </BODY>
</HTML>
