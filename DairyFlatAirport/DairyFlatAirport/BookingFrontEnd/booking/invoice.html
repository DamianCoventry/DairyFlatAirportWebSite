<!DOCTYPE html>
<HTML lang="en">
    <HEAD>
        <META charset="utf-8"/>
        <TITLE>Online Booking System</TITLE>

        <LINK href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"/>
        <LINK rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <LINK href="/styles/grid.css" rel="stylesheet"/>
        <LINK href="/styles/wizard.css" rel="stylesheet"/>

        <SCRIPT type="text/javascript" src="/javascript/bookingAPI.js"></SCRIPT>
        <SCRIPT type="text/javascript" src="/javascript/booking.js"></SCRIPT>

        <SCRIPT type="text/javascript">
            window.onload = function() {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

                const api = new BookingAPI();
                if (!api.isSignedIn()) {
                    api.signIn(window.location.href);
                }

                const booking = new Booking();
                insertFlights(booking);
                insertExtras(booking);

                bookingNumber.innerText = booking.getBookingNumber();
                totalCost.innerText = booking.getTotalCost();

                if (!booking.isReturnTrip()) {
                    returnFlightGUI.style.display = 'none';
                    returnFlightSeatsGUI.style.display = 'none';
                }

                updateSignInGui();
            }

            function updateSignInGui() {
                setSignInButtonText();
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    signInButton.style.display = 'none';
                    userDropDownDiv.style.display = '';

                    signedInUserDisplayName.innerText = api.signedInUserDisplayName;
                    signedInUserSpan.style.display = '';
                    api.getSignedInUser(
                        function (json) {
                            signedInUserDisplayName.innerText = api.signedInUserDisplayName;
                            signedInUserSpan.style.display = '';
                        },
                        showHttpError
                    );
                }
                else {
                    signInButton.style.display = '';
                    userDropDownDiv.style.display = 'none';

                    signedInUserDisplayName.innerText = '';
                    signedInUserSpan.style.display = 'none';
                }
            }

            function signIn() {
                const api = new BookingAPI();
                if (!api.isSignedIn()) {
                    api.signIn(window.location.href);
                }
                setSignInButtonText();
            }

            function signOut() {
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    api.signOut();
                    signedInUserSpan.style.display = 'none';
                }
                setSignInButtonText();
            }

            function editUserAccount() {
                const element = document.getElementById("editUserAccountModal");
                element.addEventListener('shown.bs.modal', event => {
                    saveUserAccountButton.disabled = true;
                    editUserAccountSpinner.style.display = "";
                    userAccountForm.style.display = 'none';

                    const api = new BookingAPI();
                    api.getSignedInUser(function (json) {
                            saveUserAccountButton.disabled = false;
                            editUserAccountSpinner.style.display = 'none';
                            userAccountForm.style.display = '';

                            username.value = json.username;
                            emailAddress.value = json.email;
                            firstName.value = json.first_name;
                            lastName.value = json.last_name;
                        },
                        showHttpError);
                });
                    
                const editUserAccount = new bootstrap.Modal('#editUserAccountModal');
                editUserAccount.show();
            }

            function saveUserAccount() {
                // TODO
            }

            function changePassword() {
                // TODO
            }

            function confirmDeleteUserAccount() {
                const modalDialog = new bootstrap.Modal('#finalConfirmation');
                modalDialog.show();
            }

            function deleteUserAccount() {
                deleteButton.disabled = true;
                const api = new BookingAPI();
                api.deleteSignedInUser(showHttpError); // This will also sign out the current user
            }

            function setSignInButtonText() {
                const api = new BookingAPI();
                if (api.isSignedIn()) {
                    signInButton.setAttribute('class', 'btn btn-success');
                    signInButton.innerText = 'Sign Out';
                }
                else {
                    signInButton.setAttribute('class', 'btn btn-primary');
                    signInButton.innerText = 'Sign In';
                    signedInUserDisplayName.innerText = '';
                }
            }

            function showHttpError(code, json) {
                errorMessageTitle.innerText = 'Error Received';
                errorMessageBody.innerHTML = 'The server returned HTTP code ' + code + '.<BR><BR>' + javascriptObjectToDivs(json);
                showError();
            }

            function javascriptObjectToDivs(object) {
                let html = '';
                for (var key of Object.keys(object)) {
                    html = '<div class="row"><div class="col">' + key + ': ' + object[key] + '</div></div>\r\n';
                }
                return html;
            }

            function showError() {
                const toastLiveExample = document.getElementById('responseCodePopup');
                const toast = new bootstrap.Toast(toastLiveExample);
                toast.show();
            }

            function insertFlights(booking) {
                fromCityName1.innerText = booking.getFromCityName();
                fromCityName2.innerText = booking.getFromCityName();
                fromCityDate.innerText = toLocaleDate(new Date(booking.getLeaveDate()), booking.getTimezone());
                fromCityTime.innerHTML = buildTimeHtml(booking.getLeaveTime());
                outboundFlightCostpp.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;$' + booking.getOutboundFlightCost() + ' per person';
                outboundFlightTotalCost.innerText = booking.getNumPassengers() + " \u00D7 $" + booking.getOutboundFlightCost();

                toCityName1.innerText = booking.getToCityName();
                toCityName2.innerText = booking.getToCityName();
                toCityDate.innerText = toLocaleDate(new Date(booking.getReturnDate()), booking.getTimezone());
                toCityTime.innerHTML = buildTimeHtml(booking.getReturnTime());
                inboundFlightCostpp.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;$' + booking.getInboundFlightCost() + ' per person';
                inboundFlightTotalCost.innerText = booking.getNumPassengers() + " \u00D7 $" + booking.getInboundFlightCost();
            }

            function insertExtras(booking) {
                if (!booking.hasTravelInsuranceName() && !booking.hasRentalCarName()) {
                    extrasGUI.style.display = 'none';
                    return;
                }

                if (booking.hasTravelInsuranceName()) {
                    travelInsuranceName.innerText = booking.getTravelInsuranceName();
                    travelInsuranceCostpp.innerText = '$' + booking.getTravelInsuranceCost() + ' per person';
                    travelInsuranceTotalCost.innerText = booking.getNumPassengers() + ' \u00D7 $' + booking.getTravelInsuranceCost();
                }
                else {
                    travelInsuranceGUI.style.display = 'none';
                }

                if (booking.hasRentalCarName()) {
                    rentalCarName.innerText = booking.getRentalCarName();
                    rentalCarCostpd.innerText = '$' + booking.getRentalCarCost() + ' per day';
                    rentalCarTotalCost.innerText = calcNumDays(booking) + ' \u00D7 $' + booking.getRentalCarCost();
                }
                else {
                    rentalCarGUI.style.display = 'none';
                }
            }

            function calcNumDays(booking) {
                const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
                const firstDate = new Date(booking.getLeaveDate());
                const secondDate = new Date(booking.getReturnDate());
                return Math.round(Math.abs((firstDate - secondDate) / oneDay));
            }

            function toLocaleDate(dateTime, timezone) {
                return new Date(dateTime).toLocaleDateString([],
                                {
                                    timeZone: timezone,
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short'
                                });
            }

            function buildTimeHtml(timeString) {
                const re = /(\d+:\d\d\s(AM|PM))\s(.+)/;
                const results = re.exec(timeString);
                if (results != null && results.length > 3) {
                    return '<span>' + results[1] + '</span> ' +
                           '<small class="text-muted fst-italic" style="font-size: x-small">' + results[3] + '</small>';
                }
                return '';
            }
        </SCRIPT>
    </HEAD>
    <BODY>
        <NAV class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <DIV class="container-fluid">
                <A class="navbar-brand" href="/">Home</A>
                <BUTTON class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <SPAN class="navbar-toggler-icon"/>
                </BUTTON>
                <DIV class="collapse navbar-collapse" id="navbarCollapse">
                    <UL class="navbar-nav me-auto mb-2 mb-md-0">
                        <LI class="nav-item">
                            <A class="nav-link active" href="/info/listFlights.html">Flights</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/info/listAeroplanes.html">Aeroplanes</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/user/editUser.html">User</A>
                        </LI>
                        <LI class="nav-item">
                            <A class="nav-link" href="/booking/listBookings.html">Bookings</A>
                        </LI>
                        <LI class="nav-item">
                            <BUTTON class="btn btn-success" type="button" onclick="window.location.href = '/booking/bookAFlight.html'">
                                <i class="fa-solid fa-plane"></i>&nbsp;Book a Flight</BUTTON>
                        </LI>
                    </UL>
                    <div class="d-flex align-items-center">
                        <SPAN id="signedInUserSpan" class="text-light" style="display: none;">Signed in as <SPAN class="text-primary me-3" id="signedInUserDisplayName"></SPAN></SPAN>
                        <BUTTON class="btn btn-success" id="signInButton" onclick="signIn();">Sign In</BUTTON>
                        <DIV class="btn-group" id="userDropDownDiv">
                            <BUTTON class="btn btn-success dropdown-toggle" type="button" id="userDropDown" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                                <i class="fa-solid fa-bars"></i>
                            </BUTTON>
                            <UL class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropDown">
                              <LI><BUTTON class="dropdown-item" type="button" id="userAccountMenuItem" onclick="editUserAccount();">User Account</A></LI>
                              <LI><HR class="dropdown-divider"></LI>
                              <LI><BUTTON class="dropdown-item" type="button" id="signOutMenuItem" onclick="signOut();">Sign Out</BUTTON></LI>
                            </UL>
                        </DIV>
                    </div>
                </DIV>
            </DIV>
        </NAV>

        <MAIN class="container">
            <HEADER class="pb-3 mt-3 mb-5 border-bottom">
                <h1 class="h1 d-flex align-items-center text-dark text-decoration-none">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                    <span>&nbsp;Invoice</span>
                </h1>
            </header>

            <DIV class="row mb-5">
                <ul class="wizard-progress">
                    <li class="wizard-step completed" id="searchStep">Search</li>
                    <li class="wizard-step completed" id="searchFlights">Flights</li>
                    <li class="wizard-step completed" id="searchPassengers">Passengers</li>
                    <li class="wizard-step completed" id="searchExtras">Extras</li>
                    <li class="wizard-step completed" id="searchSeats">Seats</li>
                    <li class="wizard-step completed" id="searchConfirm">Confirm</li>
                    <li class="wizard-step active" id="searchInvoice">Invoice</li>
                </ul>
            </DIV>

            <div class="row mb-4 justify-content-center">
                <div class="col-md-7">
                    <h4 class="mb-3 text-primary">Booking Completed</h4>
                    <div class="row">
                        <div class="col"><label class="form-label"><strong>Thank you</strong> for choosing to fly with Dairy Flat Airport.</label></div>
                    </div>
                    <div class="row mt-2 mb-4">
                        <div class="col">
                            <span class="fs-5">Booking Number is <span id="bookingNumber" class="fw-bold"></span>.</span>
                        </div>
                    </div>
                    <div class="row card mb-4">
                        <div class="card-header">
                            <h5 class="text-primary">Invoice</h5>
                        </div>

                        <div class="card-body my-0">
                            <h6 class="card-title">Flights</h6>
                            <div class="row card-text my-0">
                                <div class="col">
                                    <span class="text-success fw-bold" id="fromCityName1"></span> to
                                    <span class="text-success fw-bold" id="toCityName1"></span>
                                    &nbsp;&nbsp;
                                    <span id="fromCityDate"></span>&nbsp;<span id="fromCityTime"></span>
                                </div>
                            </div>
                            <div class="row card-text my-0">
                                <div class="col">
                                    <span id="outboundFlightCostpp"></span>
                                </div>
                                <div class="col text-end">
                                    <span id="outboundFlightTotalCost"></span>
                                </div>
                            </div>
                            <span id="returnFlightGUI">
                                <div class="row card-text mt-2 mb-0">
                                    <div class="col">
                                        <span class="text-success fw-bold" id="toCityName2"></span> to
                                        <span class="text-success fw-bold" id="fromCityName2"></span>
                                        &nbsp;&nbsp;
                                        <span id="toCityDate"></span>&nbsp;<span id="toCityTime"></span>
                                    </div>
                                </div>
                                <div class="row card-text my-0">
                                    <div class="col">
                                        <span id="inboundFlightCostpp"></span>
                                    </div>
                                    <div class="col text-end">
                                        <span id="inboundFlightTotalCost"></span>
                                    </div>
                                </div>
                            </span>
                            <span id="extrasGUI">
                                <h6 class="card-title mt-4">Extras</h6>
                                <span id="travelInsuranceGUI">
                                    <div class="row card-text mt-2 mb-0">
                                        <div class="col"><span id="travelInsuranceName"></span></div>
                                    </div>
                                    <div class="row card-text my-0">
                                        <div class="col">&nbsp;&nbsp;&nbsp;&nbsp;<span id="travelInsuranceCostpp"></span></div>
                                        <div class="col-2 text-end"><span id="travelInsuranceTotalCost">0</span></div>
                                    </div>
                                </span>
                                <span id="rentalCarGUI">
                                    <div class="row card-text mt-2 mb-0">
                                        <div class="col"><span id="rentalCarName"></span></div>
                                    </div>
                                    <div class="row card-text my-0">
                                        <div class="col">&nbsp;&nbsp;&nbsp;&nbsp;<span id="rentalCarCostpd"></span></div>
                                        <div class="col-2 text-end"><span id="rentalCarTotalCost">0</span></div>
                                    </div>
                                </span>
                            </span>
                        </div>

                        <div class="card-footer">
                            <div class="row">
                                <span class="col">Total (NZD)</span>
                                <strong class="col text-end">$<span id="totalCost">0</span></strong>
                            </div>
                        </div>
                    </div>

                    <form class="row g-3 justify-content-end">
                        <div class="col-auto">
                            <a class="btn btn-primary mb-3" href="/booking/listBookings.html">View Bookings</a>
                        </div>
                    </form>
                </div>
            </div>

            <FOOTER class="container">
                <P>Built by Damian Coventry, Copyright &copy; 2022, all rights reserved. &middot; <A href="#">Privacy</A> &middot; <A href="#">Terms</A>
                </P>
                <P>Flight icon created by Freepik &middot; <A href="https://www.flaticon.com/free-icons/plane" title="plane icons">Flaticon</A>
                </P>
            </FOOTER>

        </MAIN>

        <div class="modal fade" id="editUserAccountModal" tabindex="-1" aria-labelledby="editUserAccountTitle" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="editUserAccountTitle">Edit User Account</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                    </div>
                    <div class="modal-body">
                        <div class="text-center" id="editUserAccountSpinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Retrieving...</span>
                            </div>
                        </div>
                        <DIV id="userAccountForm" style="display: none;">
                            <DIV class="row">
                                <DIV class="col ms-auto text-end">
                                    <BUTTON type="button" class="btn btn-secondary"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Change Password" onclick="changePassword();">
                                        <i class="fa-solid fa-key"></i>
                                    </BUTTON>
                                    <BUTTON class="btn btn-danger" type="button"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Delete User Account" onclick="confirmDeleteUserAccount();">
                                        <i class="fa-solid fa-trash"></i>
                                    </BUTTON>
                                </DIV>
                            </DIV>
                            <DIV class="row">
                                <DIV class="col">
                                    <LABEL for="username">Username</LABEL>
                                    <INPUT type="text" class="form-control" id="username" placeholder="Username" required/>
                                </DIV>
                            </DIV>
                            <DIV class="row">
                                <DIV class="col">
                                    <LABEL for="emailAddress">Email Address</LABEL>
                                    <INPUT type="email" class="form-control" id="emailAddress" placeholder="Email Address" required/>
                                    <div class="valid-feedback">Looks good!</div>
                                    <div class="invalid-feedback">Please enter an email address</div>
                                </DIV>
                            </DIV>
                            <DIV class="row">
                                <DIV class="col">
                                    <LABEL for="firstName">First Name</LABEL>
                                    <INPUT type="text" class="form-control" id="firstName" placeholder="First Name" required/>
                                    <div class="valid-feedback">Looks good!</div>
                                    <div class="invalid-feedback">Please enter a first name</div>
                                </DIV>
                            </DIV>
                            <DIV class="row">
                                <DIV class="col">
                                    <LABEL for="lastName">Last Name</LABEL>
                                    <INPUT type="text" class="form-control" id="lastName" placeholder="Last Name" required/>
                                    <div class="valid-feedback">Looks good!</div>
                                    <div class="invalid-feedback">Please enter a last name</div>
                                </DIV>
                            </DIV>
                        </DIV>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="saveUserAccountButton" onclick="saveUserAccount();" disabled>
                            <i class="fa-solid fa-floppy-disk"></i>&nbsp;Save
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelUserAccountButton" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="finalConfirmation" tabindex="-1" aria-labelledby="deleteConfirmationTitle" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-dialog-centered  modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteConfirmationTitle">Are you sure?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                    </div>
                    <div class="modal-body">
                        This action cannot be undone. You will be logged out, and the user account will be <b>permanently</b> deleted.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="deleteButton" onclick="deleteUserAccount()">
                            <i class="fa-solid fa-trash"></i>&nbsp;Confirm
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelButton" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="responseCodePopup" class="toast fade" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger">
                    <strong class="me-auto text-white" id="errorMessageTitle"></strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorMessageBody"></div>
            </div>
        </div>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"
    integrity="sha512-2rNj2KJ+D8s1ceNasTIex6z4HWyOnEYLVC3FigGOmyQCZc2eBXKgOxQmo3oKLHyfcj53uz4QMsRCWNbLd32Q1g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<SCRIPT src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></SCRIPT>

    </BODY>
</HTML>
